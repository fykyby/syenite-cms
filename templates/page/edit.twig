{% extends 'base.twig' %}

{% block title %}
    Page: {{ page.path }}
{% endblock %}

{% block actions %}
    <button
        class="uk-btn uk-btn-default"
        data-uk-toggle="target: #page-add-block-modal"
    >
        Add Block
    </button>
    <button class="uk-btn uk-btn-primary" form="page-edit-form">Save</button>
{% endblock %}

{% block body %}
    <form class="flex flex-col" id="page-edit-form">
        {% for i, block in page.data %}
            {% include 'page/_block_fieldset.twig' with {
                block: block,
                index: i
            } %}
        {% endfor %}
    </form>
{% endblock %}

{% block modals %}
    <div id="page-add-block-modal" data-uk-modal>
        <div class="uk-modal-dialog uk-margin-auto-vertical">
            <button
                class="uk-modal-close absolute right-4 top-4"
                type="button"
                data-uk-close
            >

            </button>
            <div class="uk-modal-header">
                <h2 class="uk-modal-title">Add Block</h2>
            </div>
            <div class="uk-modal-body gap-small grid grid-cols-3">
                {% for block in blocks %}
                    <button
                        class="uk-btn uk-btn-default uk-modal-close"
                        onclick="addBlock('{{ block }}')"
                    >
                        {{ block|capitalize }}
                    </button>
                {% endfor %}
            </div>

            <div class="uk-modal-footer uk-text-right">
                <button
                    class="uk-modal-close uk-btn uk-btn-default mr-2"
                    type="button"
                >
                    Cancel
                </button>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {# prettier-ignore #}
    <script defer>
        async function addBlock(type) { 
            const form = document.getElementById("page-edit-form");
            
            const path = "/admin/pages/blocks/" + type + "?index=" + form.childElementCount;
            const response = await fetch(path);
            const html = await response.text();
            form.insertAdjacentHTML('beforeend', html)
        }

        function deleteBlock(id) {
            const block = document.getElementById(id);
            block.remove();
            updateIndexes();
        }

        function updateIndexes() {
            const form = document.getElementById("page-edit-form");

            const nodes = Array.from(form.childNodes).filter(node => node.nodeType === Node.ELEMENT_NODE);

            nodes.forEach((node, index) => {
                node.setAttribute("id", `blocks[${index}]`);

                const button = node.querySelector(".block-delete-btn");
                button.setAttribute("onclick", `deleteBlock('blocks[${index}]')`);

                const inputs = node.querySelectorAll("[name]");
                inputs.forEach(input => {
                    input.name = input.name.replace(/blocks\[\d+\]/, `blocks[${index}]`);
                });

                const elementsWithId = node.querySelectorAll("[id]");
                elementsWithId.forEach(el => {
                    el.id = el.id.replace(/blocks\[\d+\]/, `blocks[${index}]`);
                });

                const labels = node.querySelectorAll("label[for]");
                labels.forEach(label => {
                    label.htmlFor = label.htmlFor.replace(/blocks\[\d+\]/, `blocks[${index}]`);
                });

                const legend = node.querySelector("legend");
                if (legend && typeof legend.textContent === "string") {
                    legend.textContent = legend.textContent.replace(/^\s*\d+\.\s*/, `${index + 1}. `);
                }
            });
        }
    </script>
{% endblock %}
