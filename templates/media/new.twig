{% extends 'base.twig' %}

{% block title %}
    Media
{% endblock %}

{% block actions %}
    <button
        class="uk-btn uk-btn-default"
        type="button"
        x-show="files.length > 0"
        @click="clearAll()"
    >
        Clear All
    </button>

    <button
        class="uk-btn uk-btn-primary"
        form="media-upload-form"
        type="submit"
    >
        Submit
    </button>
{% endblock %}

{% block body %}
    <form
        class="uk-form-stacked"
        id="media-upload-form"
        method="post"
        enctype="multipart/form-data"
        @submit.prevent="submit"
    >
        <div
            id="upload-area"
            class="uk-rounded p-medium hover:bg-muted flex cursor-pointer flex-col items-center border text-center transition-colors"
            @click="$refs.fileInput.click()"
            @dragover.prevent="isDragOver = true"
            @dragleave.prevent="isDragOver = false"
            @drop.prevent="handleDrop($event)"
            :class="isDragOver ? 'bg-muted' : ''"
        >
            <input
                class="hidden"
                type="file"
                id="file-input"
                name="media[]"
                accept="image/*"
                multiple
                x-ref="fileInput"
                @change="handleFiles($event.target.files)"
            />

            <div class="mb-small">
                <uk-icon icon="upload"></uk-icon>
            </div>

            <p class="text-lg">
                Drop files here
            </p>

            <p class="text-sm">
                or click to browse
            </p>
        </div>

        <div x-show="files.length > 0">
            <label class="uk-form-label flex items-center">
                Selected Files (<span x-text="files.length"></span>)
            </label>

            <ul class="gap-small grid grid-cols-3">
                <template
                    x-for="(file, index) in files"
                    :key="file.id || (file.name + file.size + index)"
                >
                    <li
                        class="uk-rounded p-small flex items-center justify-between border"
                    >
                        <div>
                            <div class="truncate" x-text="file.name"></div>
                            <div
                                class="text-muted-foreground text-sm"
                                x-text="formatFileSize(file.size)"
                            ></div>
                        </div>

                        <button
                            class="uk-btn uk-btn-default uk-btn-icon"
                            type="button"
                            @click="deleteFile(index)"
                        >
                            <uk-icon icon="trash"></uk-icon>
                        </button>
                    </li>
                </template>
            </ul>
        </div>
    </form>
{% endblock %}

{% block javascripts %}
    {# prettier-ignore #}
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('body', () => ({ 
                files: [],
                isDragOver: false,
                
                handleFiles(fileList) {
                    Array.from(fileList).forEach(file => {
                        file.id = `${file.name}-${file.size}-${Date.now()}-${Math.random()}`;
                        this.files.push(file);
                    });
                    this.$refs.fileInput.value = '';
                },
                
                handleDrop(event) {
                    this.isDragOver = false;
                    const files = event.dataTransfer.files;
                    this.handleFiles(files);
                },

                deleteFile(index) {
                    this.files.splice(index, 1);
                    this.$refs.fileInput.value = '';
                },
                
                clearAll() {
                    this.files = [];
                    this.$refs.fileInput.value = '';
                },
                
                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },

                async submit() {
                    // Create a temporary fake form to persist flash message from response
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '{{ path('app_media_new') }}';
                    form.enctype = 'multipart/form-data';
                    form.style.visibility = 'hidden';

                    this.files.forEach((file, index) => {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.name = `media[]`;
                        input.files = this.createFileList(file); 
                        form.appendChild(input);
                    });

                    document.querySelector('main').appendChild(form);
                    form.submit();
                },

                createFileList(file) {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    return dataTransfer.files;
                },
            }));
        });

        document.addEventListener('dragover', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('drop', function(e) {
            e.preventDefault();
        });
    </script>
{% endblock %}
